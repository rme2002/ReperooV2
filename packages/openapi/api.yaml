openapi: 3.0.3
info:
  title: Core API
  description: |-
    Core API
  version: 0.0.1
servers:
  - url: http://localhost:8080
tags:
  - name: Health
  - name: Authentication
  - name: Transactions
  - name: Budget Plans
  - name: Insights
  - name: Expense Categories
  - name: Income Categories
  - name: Experience

paths:
  /api/v1/health:
    get:
      tags:
        - Health
      summary: Health check
      description: Health check
      operationId: healthCheck
      responses:
        '200':
          description: Success 200
          $ref: '#/components/responses/SuccessResponse200'
        '400':
          description: Error 400
          $ref: '#/components/responses/ErrorResponse400'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  # Authentication
  /api/v1/auth/sign-up:
    post:
      tags:
        - Authentication
      summary: Sign up by email and password
      description: Sign by providing their email and password
      operationId: signUpByEmailAndPassword
      requestBody:
        required: true
        description: Signup payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignUpEmailPasswordPayload'
      responses:
        '200':
          description: Successful signup
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericSuccess'
        '400':
          description: Error 400
          $ref: '#/components/responses/ErrorResponse400'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  # Transactions
  /api/v1/transactions/create-expense:
    post:
      tags:
        - Transactions
      summary: Create expense transaction
      description: Create a new expense transaction in the transactions table
      operationId: createExpenseTransaction
      requestBody:
        required: true
        description: Expense transaction payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateExpenseTransactionPayload'
      responses:
        '201':
          description: Expense transaction created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionExpense'
        '400':
          description: Error 400
          $ref: '#/components/responses/ErrorResponse400'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/transactions/create-income:
    post:
      tags:
        - Transactions
      summary: Create income transaction
      description: Create a new income transaction in the transactions table
      operationId: createIncomeTransaction
      requestBody:
        required: true
        description: Income transaction payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateIncomeTransactionPayload'
      responses:
        '201':
          description: Income transaction created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionIncome'
        '400':
          description: Error 400
          $ref: '#/components/responses/ErrorResponse400'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/transactions/list:
    get:
      tags:
        - Transactions
      summary: List transactions
      description: List all transactions for the current user within a date range. This endpoint automatically materializes recurring transactions before returning the list.
      operationId: listTransactions
      parameters:
        - name: start_date
          in: query
          description: Start date for transaction range
          required: true
          schema:
            type: string
            format: date
            example: "2024-01-01"
        - name: end_date
          in: query
          description: End date for transaction range
          required: true
          schema:
            type: string
            format: date
            example: "2024-12-31"
      responses:
        '200':
          description: List of transactions
          content:
            application/json:
              schema:
                type: array
                items:
                  oneOf:
                    - $ref: '#/components/schemas/TransactionExpense'
                    - $ref: '#/components/schemas/TransactionIncome'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/transactions/today-summary:
    get:
      tags:
        - Transactions
      summary: Get summary of today's transactions
      description: Returns aggregated totals and counts for today's expenses and income
      operationId: getTodayTransactionSummary
      responses:
        '200':
          description: Successfully retrieved today's summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TodayTransactionSummary'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericError'

  /api/v1/transactions/update/{id}:
    patch:
      tags:
        - Transactions
      summary: Update transaction
      description: Update an existing transaction (partial update). Transaction type cannot be changed.
      operationId: updateTransaction
      parameters:
        - name: id
          in: path
          description: Transaction ID
          required: true
          schema:
            $ref: '#/components/schemas/UID'
      requestBody:
        required: true
        description: Transaction update payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTransactionPayload'
      responses:
        '200':
          description: Transaction updated
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/TransactionExpense'
                  - $ref: '#/components/schemas/TransactionIncome'
        '400':
          description: Error 400
          $ref: '#/components/responses/ErrorResponse400'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '404':
          description: Transaction not found
          $ref: '#/components/responses/ErrorResponse404'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/transactions/delete/{id}:
    delete:
      tags:
        - Transactions
      summary: Delete transaction
      description: Delete an existing transaction
      operationId: deleteTransaction
      parameters:
        - name: id
          in: path
          description: Transaction ID
          required: true
          schema:
            $ref: '#/components/schemas/UID'
      responses:
        '204':
          description: Transaction deleted successfully
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '404':
          description: Transaction not found
          $ref: '#/components/responses/ErrorResponse404'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  # Recurring Templates
  /api/v1/transactions/recurring/create:
    post:
      tags:
        - Recurring Templates
      summary: Create recurring expense template
      description: Create a new recurring expense transaction template
      operationId: createRecurringExpenseTemplate
      requestBody:
        required: true
        description: Recurring expense template payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRecurringExpenseTemplatePayload'
      responses:
        '201':
          description: Recurring expense template created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecurringTemplateExpense'
        '400':
          description: Error 400
          $ref: '#/components/responses/ErrorResponse400'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/transactions/recurring/create-income:
    post:
      tags:
        - Recurring Templates
      summary: Create recurring income template
      description: Create a new recurring income transaction template
      operationId: createRecurringIncomeTemplate
      requestBody:
        required: true
        description: Recurring income template payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRecurringIncomeTemplatePayload'
      responses:
        '201':
          description: Recurring income template created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecurringTemplateIncome'
        '400':
          description: Error 400
          $ref: '#/components/responses/ErrorResponse400'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/transactions/recurring/list:
    get:
      tags:
        - Recurring Templates
      summary: List recurring templates
      description: List all recurring transaction templates for the current user
      operationId: listRecurringTemplates
      parameters:
        - name: include_paused
          in: query
          description: Include paused templates
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of recurring templates
          content:
            application/json:
              schema:
                type: array
                items:
                  oneOf:
                    - $ref: '#/components/schemas/RecurringTemplateExpense'
                    - $ref: '#/components/schemas/RecurringTemplateIncome'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  # Budget Plans
  /api/v1/budget-plans/create:
    post:
      tags:
        - Budget Plans
      summary: Create budget plan
      description: Create a new budget plan for the authenticated user
      operationId: createBudgetPlan
      parameters:
        - name: year
          in: query
          description: Year (e.g., 2025)
          required: true
          schema:
            type: integer
            minimum: 2000
            maximum: 2100
            example: 2025
        - name: month
          in: query
          description: Month (1-12)
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 12
            example: 12
      requestBody:
        required: true
        description: Budget plan creation payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBudgetPlanPayload'
      responses:
        '201':
          description: Budget plan created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetPlan'
        '400':
          description: Error 400
          $ref: '#/components/responses/ErrorResponse400'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/budget-plans/get:
    get:
      tags:
        - Budget Plans
      summary: Get budget plan
      description: Get the budget plan for the authenticated user
      operationId: getBudgetPlan
      parameters:
        - name: year
          in: query
          description: Year (e.g., 2025)
          required: true
          schema:
            type: integer
            minimum: 2000
            maximum: 2100
            example: 2025
        - name: month
          in: query
          description: Month (1-12)
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 12
            example: 12
      responses:
        '200':
          description: Budget plan retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetPlan'
        '404':
          description: Error 404
          $ref: '#/components/responses/ErrorResponse404'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/budget-plans/update:
    patch:
      tags:
        - Budget Plans
      summary: Update budget plan
      description: Update the budget plan for the authenticated user
      operationId: updateBudgetPlan
      parameters:
        - name: year
          in: query
          description: Year (e.g., 2025)
          required: true
          schema:
            type: integer
            minimum: 2000
            maximum: 2100
            example: 2025
        - name: month
          in: query
          description: Month (1-12)
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 12
            example: 12
      requestBody:
        required: true
        description: Budget plan update payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateBudgetPlanPayload'
      responses:
        '200':
          description: Budget plan updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetPlan'
        '400':
          description: Error 400
          $ref: '#/components/responses/ErrorResponse400'
        '404':
          description: Error 404
          $ref: '#/components/responses/ErrorResponse404'
        '401':
          description: Error 401
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Error 500
          $ref: '#/components/responses/ErrorResponse500'

  # Insights
  /api/v1/insights/month-snapshot:
    get:
      tags:
        - Insights
      summary: Get month snapshot
      description: Get detailed spending insights for a specific month including categories, weekly breakdown, and savings
      operationId: getMonthSnapshot
      parameters:
        - name: year
          in: query
          description: Year (e.g., 2025)
          required: true
          schema:
            type: integer
            minimum: 2000
            maximum: 2100
            example: 2025
        - name: month
          in: query
          description: Month (1-12)
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 12
            example: 12
      responses:
        '200':
          description: Month snapshot retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MonthSnapshot'
        '400':
          description: Invalid parameters
          $ref: '#/components/responses/ErrorResponse400'
        '401':
          description: Unauthorized
          $ref: '#/components/responses/ErrorResponse401'
        '404':
          description: No data for month or no budget plan
          $ref: '#/components/responses/ErrorResponse404'
        '500':
          description: Internal server error
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/insights/available-months:
    get:
      tags:
        - Insights
      summary: List available months
      description: Get list of months with transaction data, sorted by most recent first
      operationId: listAvailableMonths
      responses:
        '200':
          description: Available months retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AvailableMonth'
        '401':
          description: Unauthorized
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Internal server error
          $ref: '#/components/responses/ErrorResponse500'

  # Expense Categories
  /api/v1/expense-categories/list:
    get:
      tags:
        - Expense Categories
      summary: List expense categories
      description: Get all expense categories with subcategories
      operationId: listExpenseCategories
      responses:
        '200':
          description: List of expense categories with subcategories
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ExpenseCategory'
        '500':
          $ref: '#/components/responses/ErrorResponse500'

  # Income Categories
  /api/v1/income-categories/list:
    get:
      tags:
        - Income Categories
      summary: List income categories
      description: Get all income categories
      operationId: listIncomeCategories
      responses:
        '200':
          description: List of income categories
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/IncomeCategory'
        '500':
          $ref: '#/components/responses/ErrorResponse500'

  # Experience
  /api/v1/experience/status:
    get:
      tags:
        - Experience
      summary: Get current experience status
      description: Get current level, XP, streak, and gamification stats
      operationId: getExperienceStatus
      responses:
        '200':
          description: Current experience status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExperienceResponse'
        '401':
          description: Unauthorized
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Internal server error
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/experience/check-in:
    post:
      tags:
        - Experience
      summary: Daily check-in
      description: Award daily login XP, update streak, and check for inactivity penalties
      operationId: checkIn
      responses:
        '200':
          description: Check-in result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckInResponse'
        '401':
          description: Unauthorized
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Internal server error
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/experience/history:
    get:
      tags:
        - Experience
      summary: Get XP transaction history
      description: Get paginated history of XP events
      operationId: getExperienceHistory
      parameters:
        - name: limit
          in: query
          description: Number of events to return
          required: false
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          description: Number of events to skip
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: XP event history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExperienceHistoryResponse'
        '401':
          description: Unauthorized
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Internal server error
          $ref: '#/components/responses/ErrorResponse500'

  /api/v1/experience/streak-milestones:
    get:
      tags:
        - Experience
      summary: Get streak milestones and progress
      description: Get available streak milestones with achievement status
      operationId: getStreakMilestones
      responses:
        '200':
          description: Streak milestones
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StreakMilestonesResponse'
        '401':
          description: Unauthorized
          $ref: '#/components/responses/ErrorResponse401'
        '500':
          description: Internal server error
          $ref: '#/components/responses/ErrorResponse500'

components:
  schemas:
    UID:
      type: string
      example: "12345abcde"
    Email: # Maybe change this back to email format due to error message
      type: string
      format: email
      # pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
      example: "example@starter.com"
    Password:
      type: string
      format: password
      #      pattern: ^[a-zA-Z0-9]*[!@#$%^&*][a-zA-Z0-9!@#$%^&*]{7,19}$
      example: "1234567@"
    User:
      type: object
      properties:
        id:
          $ref: "#/components/schemas/UID"
        email:
          $ref: "#/components/schemas/Email"
      required:
        - id
        - email
    SignUpEmailPasswordPayload:
      type: object
      properties:
        email:
          $ref: "#/components/schemas/Email"
        password:
          $ref: "#/components/schemas/Password"
      required:
        - email
        - password
    SignUpEmailPasswordResponse:
      type: object
      properties:
        id:
          $ref: "#/components/schemas/UID"
        email:
          $ref: "#/components/schemas/Email"
      required:
        - id
        - email

    TransactionType:
      type: string
      enum:
        - expense
        - income
      example: expense

    TodayTransactionSummary:
      type: object
      properties:
        date:
          type: string
          format: date
          description: Date of the summary (ISO 8601 format)
        expense_total:
          type: number
          format: double
          description: Total amount of expenses today
        expense_count:
          type: integer
          description: Number of expense transactions today
        income_total:
          type: number
          format: double
          description: Total amount of income today
        income_count:
          type: integer
          description: Number of income transactions today
        has_logged_today:
          type: boolean
          description: Whether user has logged any transactions today
      required:
        - date
        - expense_total
        - expense_count
        - income_total
        - income_count
        - has_logged_today

    TransactionAmount:
      type: number
      format: double
      example: 42.5
      description: Positive decimal amount
    TransactionBase:
      type: object
      properties:
        user_id:
          $ref: "#/components/schemas/UID"
        occurred_at:
          type: string
          format: date
          example: "2024-06-01"
        amount:
          $ref: "#/components/schemas/TransactionAmount"
        notes:
          type: string
          nullable: true
          example: "makeup"
        recurring_template_id:
          $ref: "#/components/schemas/UID"
          nullable: true
          description: "ID of recurring template if this transaction was created from one"
      required:
        - user_id
        - occurred_at
        - amount

    TransactionMeta:
      type: object
      properties:
        id:
          $ref: "#/components/schemas/UID"
        created_at:
          type: string
          format: date-time
          example: "2024-06-01T13:45:00Z"
      required:
        - id
        - created_at

    CreateExpenseTransactionPayload:
      allOf:
        - $ref: "#/components/schemas/TransactionBase"
        - type: object
          properties:
            type:
              type: string
              pattern: '^expense$'
              example: "expense"
            transaction_tag:
              type: string
              example: "want"
            expense_category_id:
              type: string
              example: "personal"
            expense_subcategory_id:
              type: string
              nullable: true
              example: "beauty_care"
          required:
            - type
            - transaction_tag
            - expense_category_id
    CreateIncomeTransactionPayload:
      allOf:
        - $ref: "#/components/schemas/TransactionBase"
        - type: object
          properties:
            type:
              type: string
              pattern: '^income$'
              example: "income"
            income_category_id:
              type: string
              example: "salary"
          required:
            - type
            - income_category_id
    CreateTransactionPayload:
      oneOf:
        - $ref: "#/components/schemas/CreateExpenseTransactionPayload"
        - $ref: "#/components/schemas/CreateIncomeTransactionPayload"
      discriminator:
        propertyName: type
        mapping:
          expense: "#/components/schemas/CreateExpenseTransactionPayload"
          income: "#/components/schemas/CreateIncomeTransactionPayload"

    UpdateExpenseTransactionPayload:
      type: object
      properties:
        type:
          type: string
          pattern: '^expense$'
          example: "expense"
        occurred_at:
          type: string
          format: date
          example: "2024-06-01"
        amount:
          $ref: "#/components/schemas/TransactionAmount"
        notes:
          type: string
          nullable: true
          example: "makeup"
        transaction_tag:
          type: string
          example: "want"
        expense_category_id:
          type: string
          example: "personal"
        expense_subcategory_id:
          type: string
          nullable: true
          example: "beauty_care"
      required:
        - type

    UpdateIncomeTransactionPayload:
      type: object
      properties:
        type:
          type: string
          pattern: '^income$'
          example: "income"
        occurred_at:
          type: string
          format: date
          example: "2024-06-01"
        amount:
          $ref: "#/components/schemas/TransactionAmount"
        notes:
          type: string
          nullable: true
          example: "salary payment"
        income_category_id:
          type: string
          example: "salary"
      required:
        - type

    UpdateTransactionPayload:
      oneOf:
        - $ref: "#/components/schemas/UpdateExpenseTransactionPayload"
        - $ref: "#/components/schemas/UpdateIncomeTransactionPayload"
      discriminator:
        propertyName: type
        mapping:
          expense: "#/components/schemas/UpdateExpenseTransactionPayload"
          income: "#/components/schemas/UpdateIncomeTransactionPayload"

    TransactionExpense:
      allOf:
        - $ref: "#/components/schemas/TransactionBase"
        - $ref: "#/components/schemas/TransactionMeta"
        - type: object
          properties:
            type:
              type: string
              pattern: '^expense$'
              example: "expense"
            transaction_tag:
              type: string
              example: "want"
            expense_category_id:
              type: string
              example: "personal"
            expense_subcategory_id:
              type: string
              nullable: true
              example: "beauty_care"
          required:
            - type
            - transaction_tag
            - expense_category_id

    TransactionIncome:
      allOf:
        - $ref: "#/components/schemas/TransactionBase"
        - $ref: "#/components/schemas/TransactionMeta"
        - type: object
          properties:
            type:
              type: string
              pattern: '^income$'
              example: "income"
            income_category_id:
              type: string
              example: "salary"
          required:
            - type
            - income_category_id

    Transaction:
      oneOf:
        - $ref: "#/components/schemas/TransactionExpense"
        - $ref: "#/components/schemas/TransactionIncome"
      discriminator:
        propertyName: type
        mapping:
          expense: "#/components/schemas/TransactionExpense"
          income: "#/components/schemas/TransactionIncome"

    # Recurring Templates
    RecurringFrequency:
      type: string
      enum:
        - weekly
        - biweekly
        - monthly
      example: monthly

    RecurringTemplateBase:
      type: object
      properties:
        amount:
          $ref: "#/components/schemas/TransactionAmount"
        notes:
          type: string
          nullable: true
          example: "Netflix subscription"
        frequency:
          $ref: "#/components/schemas/RecurringFrequency"
        day_of_week:
          type: integer
          minimum: 0
          maximum: 6
          nullable: true
          example: 0
          description: Day of week for weekly/biweekly (0=Monday, 6=Sunday)
        day_of_month:
          type: integer
          minimum: 1
          maximum: 31
          nullable: true
          example: 15
          description: Day of month for monthly recurrence (1-31)
        start_date:
          type: string
          format: date
          example: "2024-06-01"
        end_date:
          type: string
          format: date
          nullable: true
          example: "2025-06-01"
        total_occurrences:
          type: integer
          nullable: true
          example: 12
          description: Total number of occurrences (alternative to end_date)
      required:
        - amount
        - frequency
        - start_date

    RecurringTemplateMeta:
      type: object
      properties:
        id:
          $ref: "#/components/schemas/UID"
        user_id:
          $ref: "#/components/schemas/UID"
        created_at:
          type: string
          format: date-time
          example: "2024-06-01T13:45:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-06-01T13:45:00Z"
        is_paused:
          type: boolean
          default: false
          description: Whether template is paused
      required:
        - id
        - user_id
        - created_at
        - updated_at
        - is_paused

    CreateRecurringExpenseTemplatePayload:
      allOf:
        - $ref: "#/components/schemas/RecurringTemplateBase"
        - type: object
          properties:
            type:
              type: string
              pattern: '^expense$'
              example: "expense"
            transaction_tag:
              type: string
              example: "want"
            expense_category_id:
              type: string
              example: "personal"
            expense_subcategory_id:
              type: string
              nullable: true
              example: "beauty_care"
          required:
            - type
            - transaction_tag
            - expense_category_id

    CreateRecurringIncomeTemplatePayload:
      allOf:
        - $ref: "#/components/schemas/RecurringTemplateBase"
        - type: object
          properties:
            type:
              type: string
              pattern: '^income$'
              example: "income"
            income_category_id:
              type: string
              example: "salary"
          required:
            - type
            - income_category_id

    RecurringTemplateExpense:
      allOf:
        - $ref: "#/components/schemas/RecurringTemplateBase"
        - $ref: "#/components/schemas/RecurringTemplateMeta"
        - type: object
          properties:
            type:
              type: string
              pattern: '^expense$'
              example: "expense"
            transaction_tag:
              type: string
              example: "want"
            expense_category_id:
              type: string
              example: "personal"
            expense_subcategory_id:
              type: string
              nullable: true
              example: "beauty_care"
          required:
            - type
            - transaction_tag
            - expense_category_id

    RecurringTemplateIncome:
      allOf:
        - $ref: "#/components/schemas/RecurringTemplateBase"
        - $ref: "#/components/schemas/RecurringTemplateMeta"
        - type: object
          properties:
            type:
              type: string
              pattern: '^income$'
              example: "income"
            income_category_id:
              type: string
              example: "salary"
          required:
            - type
            - income_category_id

    GenericSuccess:
      type: object
      description: Generic success response
      properties:
        status:
          type: integer
        message:
          type: string
          example: "Ok"
      required:
        - status
        - message
    GenericError:
      type: object
      description: Generic error response
      properties:
        status:
          type: integer
        error:
          type: string
          example: "INVALID_INPUT"
        message:
          type: string
          example: "Some error"
      required:
        - status
        - error
        - message

    CreateBudgetPlanPayload:
      type: object
      properties:
        savings_goal:
          type: number
          format: float
          nullable: true
          description: Monthly savings goal
          example: 400.0
        investment_goal:
          type: number
          format: float
          nullable: true
          description: Monthly investment goal
          example: 280.0

    UpdateBudgetPlanPayload:
      type: object
      properties:
        savings_goal:
          type: number
          format: float
          nullable: true
          description: Monthly savings goal
        investment_goal:
          type: number
          format: float
          nullable: true
          description: Monthly investment goal

    BudgetPlan:
      allOf:
        - $ref: '#/components/schemas/CreateBudgetPlanPayload'
        - type: object
          required:
            - id
            - user_id
            - expected_income
            - created_at
            - updated_at
          properties:
            id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440000"
            user_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440001"
            expected_income:
              type: number
              format: float
              description: Calculated from recurring income templates
              example: 3600.0
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time

    # Insights Schemas
    SubCategoryBreakdown:
      type: object
      required:
        - id
        - total
        - percent
        - color
      properties:
        id:
          type: string
          example: "groceries"
        total:
          type: number
          format: float
          example: 160.5
        percent:
          type: number
          format: float
          example: 50.0
          description: Percentage of parent category total
        color:
          type: string
          example: "#f7b267"

    CategoryBreakdown:
      type: object
      required:
        - id
        - total
        - percent
        - items
        - color
      properties:
        id:
          type: string
          example: "essentials"
        total:
          type: number
          format: float
          example: 320.0
        percent:
          type: number
          format: float
          example: 42.0
          description: Percentage of total spending
        items:
          type: integer
          example: 18
          description: Number of transactions in this category
        color:
          type: string
          example: "#f59a3e"
        subcategories:
          type: array
          items:
            $ref: '#/components/schemas/SubCategoryBreakdown'

    WeeklySpendingPoint:
      type: object
      required:
        - week
        - label
        - total
      properties:
        week:
          type: integer
          minimum: 1
          maximum: 6
          example: 1
        label:
          type: string
          example: "Week 1"
        total:
          type: number
          format: float
          example: 180.5

    SavingsBreakdown:
      type: object
      required:
        - saved
        - invested
      properties:
        saved:
          type: number
          format: float
          example: 120.0
          description: Total from 'savings' category
        invested:
          type: number
          format: float
          example: 85.0
          description: Total from 'investments' category
        savedDelta:
          type: number
          format: float
          nullable: true
          example: 0.08
          description: Month-over-month percentage change for savings
        investedDelta:
          type: number
          format: float
          nullable: true
          example: 0.05
          description: Month-over-month percentage change for investments

    RecentTransactionSummary:
      type: object
      required:
        - amount
        - categoryId
        - date
      properties:
        amount:
          type: number
          format: float
          example: 42.5
        categoryId:
          type: string
          example: "essentials"
        subcategoryId:
          type: string
          nullable: true
          example: "groceries"
        date:
          type: string
          format: date
          example: "2025-12-04"

    MonthSnapshot:
      type: object
      required:
        - key
        - label
        - currentDate
        - loggedDays
        - totalDays
        - totalSpent
        - budget
        - lastMonthDelta
        - categories
        - savings
        - weekly
        - transactions
      properties:
        key:
          type: string
          example: "dec-2025"
          description: Unique month identifier
        label:
          type: string
          example: "December 2025"
        currentDate:
          type: string
          format: date-time
          example: "2025-12-06T00:00:00Z"
        loggedDays:
          type: integer
          example: 12
          description: Number of days with expense transactions
        totalDays:
          type: integer
          example: 30
          description: Total days in the month
        totalSpent:
          type: number
          format: float
          example: 756.0
          description: Sum of all expense transactions
        budget:
          type: number
          format: float
          example: 1200.0
          description: From budget_plan.expected_income
        lastMonthDelta:
          type: number
          format: float
          example: 0.12
          description: Percentage change from previous month (-1.0 to +infinity)
        categories:
          type: array
          items:
            $ref: '#/components/schemas/CategoryBreakdown'
        savings:
          $ref: '#/components/schemas/SavingsBreakdown'
        weekly:
          type: array
          items:
            $ref: '#/components/schemas/WeeklySpendingPoint'
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/RecentTransactionSummary'
          description: Last 5 expense transactions

    AvailableMonth:
      type: object
      required:
        - key
        - label
        - year
        - month
      properties:
        key:
          type: string
          example: "dec-2025"
        label:
          type: string
          example: "December 2025"
        year:
          type: integer
          example: 2025
        month:
          type: integer
          minimum: 1
          maximum: 12
          example: 12

    # Category Schemas
    ExpenseCategory:
      type: object
      required:
        - id
        - label
        - color
        - sort_order
        - subcategories
      properties:
        id:
          type: string
          example: "essentials"
        label:
          type: string
          example: "Essentials"
        color:
          type: string
          example: "#f59e0b"
        sort_order:
          type: integer
          example: 1
        subcategories:
          type: array
          items:
            $ref: '#/components/schemas/ExpenseSubcategory'

    ExpenseSubcategory:
      type: object
      required:
        - id
        - category_id
        - label
        - sub_color
        - sort_order
      properties:
        id:
          type: string
          example: "groceries"
        category_id:
          type: string
          example: "essentials"
        label:
          type: string
          example: "Groceries"
        sub_color:
          type: string
          example: "#fbbf24"
        sort_order:
          type: integer
          example: 1

    IncomeCategory:
      type: object
      required:
        - id
        - label
        - color
        - sort_order
      properties:
        id:
          type: string
          example: "salary"
        label:
          type: string
          example: "Salary"
        color:
          type: string
          example: "#2563EB"
        sort_order:
          type: integer
          example: 1

    # Experience / Gamification Schemas
    EvolutionStage:
      type: string
      enum:
        - Baby
        - Young
        - Adult
        - Prime
        - Legendary
      example: "Baby"

    XPEventType:
      type: string
      enum:
        - daily_login
        - transaction
        - streak_milestone
        - inactivity_penalty
        - financial_goal
      example: "daily_login"

    ExperienceResponse:
      type: object
      required:
        - user_id
        - current_level
        - current_xp
        - xp_for_next_level
        - total_xp_for_current_level
        - evolution_stage
        - current_streak
        - longest_streak
        - transactions_today_count
        - transactions_daily_limit
      properties:
        user_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        current_level:
          type: integer
          example: 15
          description: Current player level
        current_xp:
          type: integer
          example: 1200
          description: Total accumulated XP
        xp_for_next_level:
          type: integer
          example: 150
          description: XP needed to reach next level
        total_xp_for_current_level:
          type: integer
          example: 1050
          description: Total XP needed to reach current level (cumulative)
        evolution_stage:
          $ref: '#/components/schemas/EvolutionStage'
        current_streak:
          type: integer
          example: 14
          description: Current consecutive days streak
        longest_streak:
          type: integer
          example: 30
          description: Longest streak ever achieved
        last_login_date:
          type: string
          format: date
          nullable: true
          example: "2025-01-20"
          description: Last check-in date (server-side)
        transactions_today_count:
          type: integer
          example: 3
          description: Number of transactions logged today (for XP cap)
        transactions_daily_limit:
          type: integer
          example: 5
          description: Maximum transactions that count toward XP per day

    CheckInResponse:
      type: object
      required:
        - xp_awarded
        - new_total_xp
        - new_level
        - level_up
        - streak_incremented
        - new_streak
        - streak_broken
        - message
      properties:
        xp_awarded:
          type: integer
          example: 15
          description: XP awarded from this check-in
        new_total_xp:
          type: integer
          example: 1215
          description: Total XP after check-in
        new_level:
          type: integer
          example: 15
          description: Level after check-in
        level_up:
          type: boolean
          example: false
          description: Whether user leveled up
        previous_level:
          type: integer
          nullable: true
          example: 14
          description: Previous level (only if level_up is true)
        streak_incremented:
          type: boolean
          example: true
          description: Whether streak was incremented
        new_streak:
          type: integer
          example: 15
          description: Current streak after check-in
        streak_broken:
          type: boolean
          example: false
          description: Whether streak was reset due to inactivity
        inactivity_penalties:
          type: array
          items:
            $ref: '#/components/schemas/XPEvent'
          description: List of penalty events applied (if any)
        milestone_reached:
          type: object
          nullable: true
          description: Streak milestone achieved (if any)
          properties:
            days:
              type: integer
              example: 7
            xp_reward:
              type: integer
              example: 50
        message:
          type: string
          example: "Welcome back! +15 XP"

    XPEvent:
      type: object
      required:
        - id
        - xp_amount
        - event_type
        - description
        - created_at
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        xp_amount:
          type: integer
          example: 15
          description: XP amount (can be positive or negative)
        event_type:
          $ref: '#/components/schemas/XPEventType'
        description:
          type: string
          example: "Daily check-in"
        created_at:
          type: string
          format: date-time
          example: "2025-01-20T10:00:00Z"

    ExperienceHistoryResponse:
      type: object
      required:
        - events
        - total_count
        - has_more
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/XPEvent'
        total_count:
          type: integer
          example: 145
          description: Total number of XP events
        has_more:
          type: boolean
          example: true
          description: Whether there are more events to fetch

    StreakMilestone:
      type: object
      required:
        - days
        - xp_reward
        - achieved
      properties:
        days:
          type: integer
          example: 7
          description: Number of days for this milestone
        xp_reward:
          type: integer
          example: 50
          description: XP reward for reaching this milestone
        achieved:
          type: boolean
          example: true
          description: Whether user has achieved this milestone
        achieved_at:
          type: string
          format: date-time
          nullable: true
          example: "2025-01-15T10:00:00Z"
          description: When milestone was achieved
        days_remaining:
          type: integer
          nullable: true
          example: 3
          description: Days remaining to reach this milestone (if not achieved)

    StreakMilestonesResponse:
      type: object
      required:
        - current_streak
        - milestones
      properties:
        current_streak:
          type: integer
          example: 14
          description: Current streak days
        milestones:
          type: array
          items:
            $ref: '#/components/schemas/StreakMilestone'

  responses:
    SuccessResponse200:
      description: Ok
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenericSuccess'
    ErrorResponse400:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenericError'
    ErrorResponse401:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenericError'
    ErrorResponse404:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenericError'
    ErrorResponse500:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenericError'
